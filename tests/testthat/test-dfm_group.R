context("test dfm_select")


test_that("test dfm_group", {
    
    testdfm <- dfm(c('a b c c', 'b c d', 'a'))
    expect_equivalent(
        as.matrix(dfm_group(testdfm, c('doc1', 'doc1', 'doc2'))),
        matrix(c(1, 1, 2, 0, 3, 0, 1, 0), nrow = 2, 
               dimnames = list(c('doc1', 'doc2'), c('a', 'b', 'c', 'd')))
    )
    
    expect_equivalent(
        as.matrix(dfm_group(testdfm, c(1, 1, 2))),
        matrix(c(1, 1, 2, 0, 3, 0, 1, 0), nrow = 2, 
               dimnames = list(c('doc1', 'doc2'), c('a', 'b', 'c', 'd')))
    )
})

test_that("dfm_group works with empty documents", {
    
    testdfm <- dfm(c('a b c c', 'b c d', ''))
    expect_equivalent(
        as.matrix(dfm_group(testdfm, c('doc1', 'doc1', 'doc2'))),
        matrix(c(1, 0, 2, 0, 3, 0, 1, 0), nrow = 2, 
               dimnames = list(c('doc1', 'doc2'), c('a', 'b', 'c', 'd')))
    )
    
    expect_equivalent(
        as.matrix(dfm_group(testdfm, c(1, 1, 2))),
        matrix(c(1, 0, 2, 0, 3, 0, 1, 0), nrow = 2, 
               dimnames = list(c('doc1', 'doc2'), c('a', 'b', 'c', 'd')))
    )
})

test_that("dfm_group works with docvars", {
    mycorpus <- corpus(c("a a b", "a b c c", "a c d d", "a c c d"),
                       docvars = data.frame(grp = c(1, 1, 2, 2)))
    mydfm <- dfm(mycorpus)
    expect_equal(
        colSums(dfm_group(mydfm, groups = "grp")),
        colSums(mydfm)
    )
})

test_that("dfm.character groups works (#794)", {
    txt <- c(d1 = "one two three", d2 = "two three four", d3 = "one three four")
    corp <- corpus(txt, docvars = data.frame(grp = c(1, 1, 2)))
    toks <- tokens(corp)
    expect_equal(
        dfm(txt, groups = docvars(corp, "grp")),
        dfm(toks, groups = "grp")
    )
    expect_equal(
        dfm(txt, groups = docvars(corp, "grp")),
        dfm(corp, groups = "grp")
    )
})

test_that("test dfm_group with factor levels, #854", {
    
    testdfm <- dfm(c('a b c c', 'b c d', 'a'))
    expect_equivalent(
        as.matrix(dfm_group(testdfm, factor(c('doc1', 'doc1', 'doc2'), 
                                            levels = c('doc0', 'doc1', 'doc2', 'doc3')))),
        matrix(c(0, 1, 1, 0, 0, 2, 0, 0, 0, 3, 0, 0, 0, 1, 0, 0), nrow = 4, 
               dimnames = list(c('doc0', 'doc1', 'doc2', 'doc3'), c('a', 'b', 'c', 'd')))
    )
    
    expect_equivalent(
        as.matrix(dfm_group(testdfm, factor(c(1, 1, 2), 
                                            levels = c(4, 3, 2, 1)))),
        matrix(c(0, 0, 1, 1, 0, 0, 0, 2, 0, 0, 0, 3, 0, 0, 0, 1), nrow = 4, 
               dimnames = list(c('4', '3', '2', '1'), c('a', 'b', 'c', 'd')))
    )
})
